package br.ufla.tmsmap.test;

import br.ufla.tmsmap.*;
import com.vividsolutions.jts.geom.Geometry;
import com.vividsolutions.jts.geom.GeometryFactory;
import com.vividsolutions.jts.io.ParseException;
import com.vividsolutions.jts.io.WKTReader;
import org.geotools.geometry.jts.ReferencedEnvelope;
import org.geotools.referencing.crs.DefaultGeographicCRS;
import org.testng.annotations.Test;

import java.awt.*;
import java.io.File;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.MalformedURLException;

import static org.assertj.core.api.Assertions.assertThat;

public class LabelLayerTest {

	public static final String POLY_01 = "Polygon ((-45.2550879639873358 -21.05959353952608382, -45.25445399148958359 -21.06025090217176299, -45.25332692927138112 -21.06064531836515741, -45.25276339816226567 -21.06090826191324794, -45.25191810149861027 -21.06163135427443933, -45.2507910392804007 -21.06202576680841787, -45.25001618400537495 -21.06202576680841787, -45.24945265289626661 -21.06215723742072754, -45.24881868039852151 -21.06261738364891656, -45.24839603206670091 -21.06314326330988962, -45.24818470790078351 -21.0638663448084813, -45.24832559067806415 -21.06445795432955848, -45.24846647345533768 -21.0652467633644136, -45.24881868039852151 -21.06557543256109355, -45.24945265289626661 -21.06577263373053199, -45.25008662539401882 -21.06610130176529339, -45.25086148066903746 -21.0662985022375544, -45.25100236344631099 -21.06662716911036881, -45.25050927372584653 -21.06702156839913087, -45.24959353567354725 -21.0662985022375544, -45.24917088734171244 -21.06642996907383036, -45.25001618400537495 -21.06761316537140161, -45.25065015650312006 -21.06807329472302115, -45.25057971511448329 -21.06866488751202482, -45.25036839094856589 -21.06932221007324912, -45.25072059789175682 -21.0698480660304881, -45.25121368761222129 -21.07083404093866363, -45.25170677733269997 -21.07129416032535119, -45.25135457038950904 -21.07168854723796514, -45.25029794955992912 -21.07208293310459268, -45.24910044595307568 -21.07257591396695773, -45.24811426651214674 -21.07310175841869437, -45.24758595609736034 -21.07326608442850002, -45.24705764568256683 -21.07329894960867023, -45.24667021804505396 -21.0734304102566945, -45.24614190763026755 -21.07366046611108246, -45.24568403860412502 -21.07398911671416641, -45.24543749374389279 -21.07451495616811599, -45.24526139027229021 -21.07523798238073098, -45.24483874194046251 -21.07573095278249298, -45.24420476944271741 -21.07635537961147776, -45.24392300388815613 -21.07727558278961055, -45.24374690041656777 -21.077867138967747, -45.24353557625065747 -21.07829437252129168, -45.2432538106961033 -21.07855728486703484, -45.24297204514154203 -21.07855728486703484, -45.24254939680971432 -21.07852442084924149, -45.24202108639492792 -21.07852442084924149, -45.24170410014605892 -21.07845869279187667, -45.24096446556535511 -21.07826150844539725, -45.24008394820738488 -21.07836010065132726, -45.23895688598916109 -21.07875446882117387, -45.23835813418573792 -21.07944461060084151, -45.23779460307663669 -21.08085774805650203, -45.23709018919024771 -21.0819751030448046, -45.23620967183227037 -21.08269809297280872, -45.23525871308564916 -21.08279668223593717, -45.23448385781063763 -21.08250091425033901, -45.23416687156176152 -21.08200796629964557, -45.23392032670152219 -21.08141642660065074, -45.23381466461857059 -21.08095633854041751, -45.23381466461857059 -21.08039765826687528, -45.23374422322993382 -21.07983897589344124, -45.23367378184128995 -21.07951033822226705, -45.23335679559242095 -21.07914883594476763, -45.23286370587194938 -21.07882019674776686, -45.23230017476284104 -21.07859014887756288, -45.23156054018213723 -21.07845869279187667, -45.23075046421280376 -21.07839296470544355, -45.22934163644002581 -21.07862301288081497, -45.22807369144454981 -21.07872160484697943, -45.22652398089450543 -21.0790173803531502, -45.23008127102072962 -21.07152421948480736, -45.25163633594406321 -21.05982361678241332, -45.2550879639873358 -21.05959353952608382))";
	public static final GeometryFactory GEOMETRY_FACTORY = new GeometryFactory();
	public static final Viewport VIEWPORT = Viewport.of(new ReferencedEnvelope(-45.28374, -45.18135, -21.13236, -21.04297, DefaultGeographicCRS.WGS84), 12);

	public static Geometry geomOf(String wkt) throws ParseException {
		return new WKTReader(GEOMETRY_FACTORY).read(wkt);
	}

	private TMSLayer getTmsLayer() throws MalformedURLException, UnsupportedEncodingException {
		return TMSLayer.from(new File("test-data/lavras/{z}/{x}/{y}.png"), false);
	}

	@Test
	public void simpleLabelTest() throws ParseException, IOException {

		TMSMap map = new TMSMap();

		Geometry geom = geomOf(POLY_01);

		PolygonStyle style = new PolygonStyle();
		style.fillOpacity(0.1f)
			.fillColor(new Color(0x00, 0xff, 0xff))
			.color(new Color(0xff, 0x00, 0x00))
			.width(1);

		Font font = new Font(Font.MONOSPACED, Font.BOLD, 10);
		Color color = new Color(0xFFFFFF);

		map.addLayer(getTmsLayer());
		map.addLayer(ScaleBar.Simple.from(ScaleBar.Simple.style().font(new Font(Font.SANS_SERIF, Font.BOLD, 16)).fontColor(new Color(0xff, 0xff, 0x00))).bottom(10).right(15).height(16));
		map.addLayer(new LabelLayer("Label test", geom.getEnvelopeInternal().centre(), font, color));
		map.addLayer(JTSLayer.from(DefaultGeographicCRS.WGS84, style, geom));

		map.setViewport(VIEWPORT);

		int[] ws = {1000}, hs = {1000};

		for (int i = 0; i < ws.length; i++) {
			File out = File.createTempFile(String.format("TMS-JTS-LABEL-%dx%d-", ws[i], hs[i]), ".png");
			map.render(ws[i], hs[i], out);

			assertThat(out).exists().canRead().has(FileHelper.HAS_SOME_CONTENT);
		}
	}

}
